<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Score Sheet</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f7f3f0;
      margin: 0;
      padding: 10px;
    }
    .form-container {
      background-color: #ffffff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      max-width: 700px;
      margin: auto;
      border: 2px solid #6b2c3e;
    }
    .logo-title-container {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }
    .logo {
      height: 80px;
      margin-right: 20px;
    }
    h2 {
      text-align: center;
      color: #6b2c3e;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #6b2c3e;
      padding: 10px;
      text-align: center;
      background-color: #ffffff;
    }
    th {
      background-color: #e1d4c8;
      color: #6b2c3e;
    }
    select {
      width: 90%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #6b2c3e;
      border-radius: 4px;
      background-color: #f7f3f0;
    }
    textarea {
      overflow-y: hidden;
      resize: none;
      width: 100%;
      border: 1px solid #6b2c3e;
      border-radius: 4px;
      padding: 8px;
      background-color: #f7f3f0;
    }
    input[type="button"], .add-score {
      padding: 10px;
      background-color: #6b2c3e;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      flex: 1;
    }
    .taller-button {
      padding: 12.5px 10px; /* Increase height by 25% */
    }
    input[type="button"]:hover, .add-score:hover {
      background-color: #5a2435;
    }
    .locked {
      background-color: #ffffff;
      pointer-events: none;
    }
    .popup {
      display: none;
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background-color: #fff;
      padding: 20px;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
      z-index: 100;
    }
    .popup select, .popup input[type="button"] {
      width: 100%;
      margin-top: 10px;
    }
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 99;
    }
    /* Center team list boxes */
    .team-list-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .team-list-container > div {
      flex: 1;
      margin: 0 10px;
    }
    /* Responsive adjustments */
    @media (max-width: 600px) {
      .logo-title-container {
        flex-direction: column;
      }
      .logo {
        margin-right: 0;
        margin-bottom: 10px;
      }
      .team-list-container {
        flex-direction: column;
        align-items: center;
      }
      .team-list-container > div {
        margin: 10px 0;
      }
    }
  </style>
</head>
<body>
  <div class="form-container">
    <div class="logo-title-container">
      <img src="SU Comm - Portfolio Logo.jpg" alt="Stellenbosch University Logo" class="logo">
      <h2>Stellenbosch Ultimate Frisbee</h2>
    </div>
    <form id="scoreForm">
      <!-- Description Table -->
      <table>
        <tr>
          <th>Team A</th>
          <td>
            <select id="teamA" required>
              <option value="">Select Team A</option>
            </select>
          </td>
        </tr>
        <tr>
          <th>Team B</th>
          <td>
            <select id="teamB" required>
              <option value="">Select Team B</option>
            </select>
          </td>
        </tr>
        <tr>
          <th>Time</th>
          <td><input type="text" id="time" value="" readonly></td>
        </tr>
      </table>

      <!-- Scoring Table -->
      <table>
        <tr>
          <th>Score A</th>
          <th>Assist A</th>
          <th>Total</th>
          <th>Score B</th>
          <th>Assist B</th>
        </tr>
        <tbody id="scoringTableBody"></tbody>
      </table>

      <!-- Add Score Buttons -->
      <div style="display: flex; justify-content: space-between;">
        <button type="button" class="add-score taller-button" onclick="openPopup('A')">+ Add Score for Team A</button>
        <button type="button" class="add-score" onclick="openPopup('B')">+ Add Score for Team B</button>
      </div>

      <!-- Team List Section -->
      <div class="team-list-container">
        <div>
          <h3>Team A Players</h3>
          <textarea id="teamAList" readonly></textarea>
        </div>
        <div>
          <h3>Team B Players</h3>
          <textarea id="teamBList" readonly></textarea>
        </div>
      </div>

      <input type="button" value="Submit" onclick="submitScore()">
    </form>
  </div>

  <!-- Popup for Adding Score -->
  <div class="overlay" id="overlay"></div>
  <div class="popup" id="scorePopup">
    <button type="button" onclick="closePopup()" style="float: right; background: none; border: none; font-size: 16px; cursor: pointer;">&times;</button>
    <h3>Add Score</h3>
    <select id="scorer" required>
      <option value="">Select Scorer</option>
    </select>
    <select id="assist" required>
      <option value="">Select Assist</option>
    </select>
    <input type="button" value="Add Score" onclick="addScore()">
  </div>

  <script>
    // Initialize score variables
    let teamAScore = 0;
    let teamBScore = 0;

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById('time').value = new Date().toLocaleString();
      fetchTeams();
    });

    async function fetchTeams() {
      const storedTeams = sessionStorage.getItem('teams');
      if (storedTeams) {
        const teams = JSON.parse(storedTeams);
        populateTeamOptions(teams);
      } else {
        try {
          const response = await fetch('https://script.google.com/macros/s/AKfycbz7Dt-au2pT1VoHY0aclvtxyRxBR2tig6kp_R7Cw9Gij9_U6D3h_YaI4fo55VLbzXaS/exec');
          const teams = await response.json();
          sessionStorage.setItem('teams', JSON.stringify(teams));
          populateTeamOptions(teams);
        } catch (error) {
          console.error('Error fetching team names:', error);
        }
      }
    }

    function populateTeamOptions(teams) {
      const teamASelect = document.getElementById('teamA');
      const teamBSelect = document.getElementById('teamB');
      const uniqueTeams = [...new Set(teams.map(item => item.teamA))];

      uniqueTeams.forEach(team => {
        const option = new Option(team, team);
        teamASelect.add(option);
        teamBSelect.add(option.cloneNode(true));
      });

      teamASelect.addEventListener('change', () => updatePlayerList('teamA'));
      teamBSelect.addEventListener('change', () => updatePlayerList('teamB'));
    }

    function updatePlayerList(team) {
      const teams = JSON.parse(sessionStorage.getItem('teams'));
      const selectedTeam = document.getElementById(team).value;
      const playerListElement = document.getElementById(`${team}List`);
      const players = teams.filter(item => item.teamA === selectedTeam).map((item, index) => `${index + 1} - ${item.teamB}`);
      playerListElement.value = players.join('\n');

      // Adjust the height of the textarea to fit the content
      playerListElement.style.height = 'auto';
      playerListElement.style.height = (playerListElement.scrollHeight) + 'px';
    }

    function openPopup(team) {
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('scorePopup').style.display = 'block';

      const scorerDropdown = document.getElementById('scorer');
      const assistDropdown = document.getElementById('assist');
      scorerDropdown.innerHTML = '<option value="">Select Scorer</option>';
      assistDropdown.innerHTML = '<option value="">Select Assist</option>';

      const players = document.getElementById(team === 'A' ? 'teamAList' : 'teamBList').value.split('\n');
      players.forEach(player => {
        scorerDropdown.innerHTML += `<option value="${player}">${player}</option>`;
        assistDropdown.innerHTML += `<option value="${player}">${player}</option>`;
      });

      document.getElementById('scorePopup').dataset.team = team;
    }

    function addScore() {
      const team = document.getElementById('scorePopup').dataset.team;
      const scorer = document.getElementById('scorer').value;
      const assist = document.getElementById('assist').value;

      if (scorer && assist) {
        const scoringTableBody = document.getElementById('scoringTableBody');
        const row = document.createElement('tr');
        if (team === 'A') {
          row.innerHTML = `
            <td>${scorer}</td>
            <td>${assist}</td>
            <td class="total"></td>
            <td></td>
            <td></td>
          `;
        } else {
          row.innerHTML = `
            <td></td>
            <td></td>
            <td class="total"></td>
            <td>${scorer}</td>
            <td>${assist}</td>
          `;
        }
        scoringTableBody.appendChild(row);
        updateScore(team);

        // Update the 'Total' cell
        const totalCell = row.querySelector('.total');
        totalCell.textContent = `${teamAScore}:${teamBScore}`;

        closePopup();
      } else {
        alert('Please select both scorer and assist.');
      }
    }

    function updateScore(team) {
      if (team == 'A') {
        teamAScore += 1;
      } else if (team == 'B') {
        teamBScore += 1;
      }
    }

    function closePopup() {
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('scorePopup').style.display = 'none';
    }

    async function submitScore() {
      try {
        const data = {
          teamA: document.getElementById('teamA').value,
          teamB: document.getElementById('teamB').value,
          time: document.getElementById('time').value,
          scores: Array.from(document.querySelectorAll('#scoringTableBody tr')).map(row => ({
            scoreA: row.cells[0].textContent || "",
            assistA: row.cells[1].textContent || "",
            total: row.cells[2].textContent || "",
            scoreB: row.cells[3].textContent || "",
            assistB: row.cells[4].textContent || ""
          }))
        };

        const response = await fetch('https://script.google.com/macros/s/AKfycbz7Dt-au2pT1VoHY0aclvtxyRxBR2tig6kp_R7Cw9Gij9_U6D3h_YaI4fo55VLbzXaS/exec', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
        const result = await response.json();
        alert(result.status);
      } catch (error) {
        alert('Error submitting score: ' + error.message);
      }
    }
  </script>
</body>
</html>
